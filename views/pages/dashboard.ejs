<%- include('../partials/header') %>

<style>
  .metric-card {
    background: var(--card-bg);
    border-radius: 16px;
    padding: 1.5rem;
    text-align: center;
    box-shadow: 0 4px 20px rgba(0,0,0,0.2);
    transition: transform 0.2s;
  }
  .metric-card:hover {
    transform: translateY(-4px);
  }
  .metric-value {
    font-size: 2.2rem;
    font-weight: 700;
    margin: 0.5rem 0;
    background: linear-gradient(45deg, var(--secondary), var(--primary));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
  }
  .live-item {
    padding: 0.75rem;
    border-bottom: 1px solid #2a2a3a;
    opacity: 0;
    animation: fadeInSlide 0.6s forwards;
  }
  @keyframes fadeInSlide {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }
  #liveFlow {
    max-height: 320px;
    overflow-y: auto;
  }
</style>

<section style="padding: 2.5rem 0;">
  <h2 style="text-align: center; margin-bottom: 2.5rem; color: var(--secondary);">
    <i class="fas fa-chart-line"></i> Dashboard Wanzofc API
  </h2>

  <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 1.5rem; max-width: 900px; margin: 0 auto 2.5rem;">
    <div class="metric-card">
      <h3><i class="fas fa-users"></i> Total Visitor</h3>
      <div id="totalRequests" class="metric-value"><%= stats.totalRequests || 0 %></div>
      <p style="color: #aaa; font-size: 0.9rem;">Request sejak server jalan</p>
    </div>
    <div class="metric-card">
      <h3><i class="fas fa-code"></i> API Tersedia</h3>
      <div class="metric-value">8+</div>
      <p style="color: #aaa; font-size: 0.9rem;">Pakasir, QRIS, VA, Retail</p>
    </div>
    <div class="metric-card">
      <h3><i class="fas fa-bolt"></i> Pakasir Ready</h3>
      <div class="metric-value">✅</div>
      <p style="color: #aaa; font-size: 0.9rem;">Integrasi aktif</p>
    </div>
  </div>

  <div style="max-width: 900px; margin: 0 auto;">
    <h3 style="margin-bottom: 1.25rem; color: var(--accent); display: flex; align-items: center; gap: 0.5rem;">
      <i class="fas fa-exchange-alt"></i> Live Traffic Flow
    </h3>
    <div id="liveFlow" style="background: var(--card-bg); border-radius: 16px;">
      <div style="padding: 1.5rem; text-align: center; color: #666;">
        Menunggu aktivitas...
      </div>
    </div>
  </div>
</section>

<!-- Framer Motion Onboarding Tour -->
<div id="tourModal" style="display:none;">
  <div style="position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 2000; display: flex; align-items: center; justify-content: center;">
    <motion.div
      initial={{ scale: 0.8, opacity: 0 }}
      animate={{ scale: 1, opacity: 1 }}
      transition={{ type: 'spring', damping: 15 }}
      style="background: var(--card-bg); padding: 2rem; border-radius: 20px; max-width: 500px; width: 90%; color: white;"
    >
      <h3 style="color: var(--secondary); margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
        <i class="fas fa-rocket"></i> Selamat Datang di Wanzofc API
      </h3>
      <p style="margin-bottom: 1.5rem; line-height: 1.6; color: #ddd;">
        Dashboard ini menampilkan:
        <br>• Statistik real-time penggunaan API
        <br>• Live traffic dari semua request
        <br>• Integrasi siap pakai dengan <strong>Pakasir</strong>
      </p>
      <button onclick="closeTour()" class="btn btn-primary" style="width: 100%; padding: 12px; font-weight: 600;">
        Mulai Eksplorasi!
      </button>
    </motion.div>
  </div>
</div>

<%- include('../partials/footer') %>

<script>
  function closeTour() {
    localStorage.setItem('wanzofcDashboardTourSeen', 'true');
    document.getElementById('tourModal').style.display = 'none';
  }

  async function fetchLiveTraffic() {
    try {
      const res = await fetch('/api/live-traffic');
      const data = await res.json();
      const container = document.getElementById('liveFlow');

      if (data.logs && data.logs.length > 0) {
        const html = data.logs.map(log => `
          <div class="live-item">
            <code>${log.method} ${log.url}</code>
            <span style="float: right; color: #666; font-size: 0.85rem;">${new Date(log.time).toLocaleTimeString()}</span>
          </div>
        `).join('');
        container.innerHTML = html;
      } else {
        container.innerHTML = '<div style="padding: 1.5rem; text-align: center; color: #666;">Belum ada aktivitas</div>';
      }
    } catch (err) {
      console.error('Gagal memuat live traffic:', err);
    }
  }

  // Jalankan tour jika belum pernah
  if (!localStorage.getItem('wanzofcDashboardTourSeen')) {
    document.getElementById('tourModal').style.display = 'block';
  }

  // Polling live traffic setiap 2.5 detik
  fetchLiveTraffic();
  setInterval(fetchLiveTraffic, 2500);
</script>